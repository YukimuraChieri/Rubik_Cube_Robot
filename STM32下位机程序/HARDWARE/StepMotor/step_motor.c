#include "step_motor.h"

// 旋转列表指针
u16* S_Curve_List;
u16 len;						// 长度
u8 motor_AB = '\0';	// 左右电机选择
u8 stepRun = 0;			// 电机运行状态
u8 brkFlag = 0;			// 刹车信号
u16 PulCnt = 0;			// 脉冲计数
u8 stepFinish = 0;	// 电机完成状态


// S曲线低速旋转90度脉冲周期列表，最大加速度20r/s^2，加减速时间0.1S
const u16 Rot90_LS_List[250] = {
	9999,	9523,	8398,	7194,	6185,	5396,	4783,	4300,	3911,	3594,	
	3329,	3105,	2914,	2747,	2602,	2473,	2359,	2256,	2164,	2080,	
	2003,	1933,	1868,	1809,	1754,	1702,	1655,	1611,	1571,	1535,	
	1502,	1471,	1442,	1416,	1391,	1368,	1347,	1327,	1308,	1290,	
	1273,	1257,	1241,	1227,	1213,	1200,	1188,	1176,	1164,	1154,	
	1143,	1133,	1124,	1115,	1106,	1098,	1090,	1082,	1075,	1067,	
	1061,	1054,	1048,	1041,	1035,	1030,	1024,	1019,	1014,	1009,	
	1004,	1000,	995,	991,	987,	983,	979,	975,	972,	968,	
	965,	962,	959,	956,	953,	950,	948,	945,	943,	940,	
	938,	936,	934,	932,	930,	928,	926,	925,	923,	922,	
	920,	919,	918,	917,	916,	915,	914,	913,	912,	911,	
	911,	910,	910,	909,	909,	909,	908,	908,	908,
	908,	908,	908,	908,	908,	908,	908,	908,	908,	908,	
	908,	908,	908,	908,	909,	909,	909,	910,	910,	911,	
	911,	912,	913,	914,	915,	916,	917,	918,	919,	920,	
	922,	923,	925,	926,	928,	930,	932,	934,	936,	938,	
	940,	943,	945,	948,	950,	953,	956,	959,	962,	965,	
	968,	972,	975,	979,	983,	987,	991,	995,	1000,	1004,	
	1009,	1014,	1019,	1024,	1030,	1035,	1041,	1048,	1054,	1061,	
	1067,	1075,	1082,	1090,	1098,	1106,	1115,	1124,	1133,	1143,	
	1154,	1164,	1176,	1188,	1200,	1213,	1227,	1241,	1257,	1273,	
	1290,	1308,	1327,	1347,	1368,	1391,	1416,	1442,	1471,	1502,	
	1535,	1571,	1611,	1655,	1702,	1754,	1809,	1868,	1933,	2003,	
	2080,	2164,	2256,	2359,	2473,	2602,	2747,	2914,	3105,	3329,	
	3594,	3911,	4300,	4783,	5396,	6185,	7194,	8398,	9523,	9999, 1
};

// S曲线低速旋转180度脉冲周期列表，最大加速度20r/s^2，加减速时间0.2S
const u16 Rot180_LS_List[501] = {
	9999,	9090,	7328,	5888,	4892,	4194,	3684,	3297,	2993,	2747,	
	2544,	2374,	2228,	2102,	1993,	1896,	1809,	1732,	1662,	1599,	
	1541,	1488,	1439,	1394,	1352,	1313,	1277,	1243,	1212,	1182,	
	1154,	1127,	1102,	1078,	1056,	1035,	1014,	995,	976,	959,	
	942,	925,	910,	895,	881,	868,	855,	843,	832,	821,	
	811,	801,	792,	783,	774,	766,	758,	750,	743,	736,	
	729,	723,	716,	710,	704,	699,	693,	688,	682,	677,	
	672,	668,	663,	659,	654,	650,	646,	642,	638,	634,	
	631,	627,	624,	620,	617,	614,	610,	607,	604,	601,	
	599,	596,	593,	590,	588,	585,	583,	580,	578,	575,	
	573,	571,	569,	567,	564,	562,	560,	558,	556,	555,	
	553,	551,	549,	547,	546,	544,	542,	541,	539,	537,	
	536,	534,	533,	532,	530,	529,	527,	526,	525,	523,	
	522,	521,	520,	519,	517,	516,	515,	514,	513,	512,	
	511,	510,	509,	508,	507,	506,	505,	504,	503,	502,	
	502,	501,	500,	499,	498,	498,	497,	496,	495,	495,	
	494,	493,	493,	492,	491,	491,	490,	489,	489,	488,	
	488,	487,	487,	486,	486,	485,	485,	484,	484,	483,	
	483,	483,	482,	482,	481,	481,	481,	480,	480,	480,	
	479,	479,	479,	479,	478,	478,	478,	478,	477,	477,	
	477,	477,	477,	476,	476,	476,	476,	476,	476,	476,	
	476,	475,	475,	475,	475,	475,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	475,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	475,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	475,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	475,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	475,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	475,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	475,	475,	475,	475,	476,	
	476,	476,	476,	476,	476,	476,	476,	477,	477,	477,	
	477,	477,	478,	478,	478,	478,	479,	479,	479,	479,	
	480,	480,	480,	481,	481,	481,	482,	482,	483,	483,	
	483,	484,	484,	485,	485,	486,	486,	487,	487,	488,	
	488,	489,	489,	490,	491,	491,	492,	493,	493,	494,	
	495,	495,	496,	497,	498,	498,	499,	500,	501,	502,	
	502,	503,	504,	505,	506,	507,	508,	509,	510,	511,	
	512,	513,	514,	515,	516,	517,	519,	520,	521,	522,	
	523,	525,	526,	527,	529,	530,	532,	533,	534,	536,	
	537,	539,	541,	542,	544,	546,	547,	549,	551,	553,	
	555,	556,	558,	560,	562,	564,	567,	569,	571,	573,	
	575,	578,	580,	583,	585,	588,	590,	593,	596,	599,	
	601,	604,	607,	610,	614,	617,	620,	624,	627,	631,	
	634,	638,	642,	646,	650,	654,	659,	663,	668,	672,	
	677,	682,	688,	693,	699,	704,	710,	716,	723,	729,	
	736,	743,	750,	758,	766,	774,	783,	792,	801,	811,	
	821,	832,	843,	855,	868,	881,	895,	910,	925,	942,	
	959,	976,	995,	1014,	1035,	1056,	1078,	1102,	1127,	1154,	
	1182,	1212,	1243,	1277,	1313,	1352,	1394,	1439,	1488,	1541,	
	1599,	1662,	1732,	1809,	1896,	1993,	2102,	2228,	2374,	2544,	
	2747,	2993,	3297,	3684,	4194,	4892,	5888,	7328,	9090,	9999,	1
};


// S曲线中速旋转90度脉冲周期列表，最大加速度40r/s^2，加减速时间0.1S
const u16 Rot90_MS_List[250] = {
	9999,	7142,	4596,	3459,	2824,	2414,	2124,	1907,	1737,	1600,	
	1487,	1392,	1311,	1240,	1178,	1123,	1074,	1030,	991,	954,	
	921,	891,	864,	840,	818,	798,	780,	763,	748,	733,	
	720,	708,	696,	685,	675,	666,	657,	648,	640,	633,	
	626,	619,	612,	606,	600,	594,	589,	584,	579,	574,	
	570,	565,	561,	557,	554,	550,	546,	543,	540,	537,	
	534,	531,	528,	525,	523,	520,	518,	516,	513,	511,	
	509,	507,	505,	504,	502,	500,	499,	497,	496,	494,	
	493,	492,	490,	489,	488,	487,	486,	485,	484,	483,	
	482,	482,	481,	480,	480,	479,	478,	478,	477,	477,	
	477,	476,	476,	476,	476,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	475,	475,	475,	475,	475,		
	475,	475,	475,	475,	475,	475,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	475,	475,	475,	475,	475,	
	475,	475,	475,	475,	475,	476,	476,	476,	476,	477,	
	477,	477,	478,	478,	479,	480,	480,	481,	482,	482,	
	483,	484,	485,	486,	487,	488,	489,	490,	492,	493,	
	494,	496,	497,	499,	500,	502,	504,	505,	507,	509,	
	511,	513,	516,	518,	520,	523,	525,	528,	531,	534,	
	537,	540,	543,	546,	550,	554,	557,	561,	565,	570,	
	574,	579,	584,	589,	594,	600,	606,	612,	619,	626,	
	633,	640,	648,	657,	666,	675,	685,	696,	708,	720,	
	733,	748,	763,	780,	798,	818,	840,	864,	891,	921,	
	954,	991,	1030,	1074,	1123,	1178,	1240,	1311,	1392,	1487,	
	1600,	1737,	1907,	2124,	2414,	2824,	3459,	4596,	7142,	9999,	 1
};


// S曲线中速旋转180度脉冲周期列表，最大加速度40r/s^2，加减速时间0.15S
const u16 Rot180_MS_List[501] = {
	9999,	7894,	5393,	4087,	3334,	2844,	2497,	2238,	2036,	1873,	
	1738,	1625,	1529,	1445,	1372,	1307,	1249,	1198,	1151,	1108,	
	1069,	1034,	1001,	970,	942,	916,	891,	868,	847,	826,	
	807,	789,	772,	756,	740,	726,	712,	698,	686,	674,	
	662,	651,	640,	630,	620,	611,	602,	593,	585,	578,	
	570,	563,	557,	550,	544,	538,	533,	527,	522,	517,	
	512,	508,	503,	499,	494,	490,	486,	483,	479,	475,	
	472,	468,	465,	462,	459,	456,	453,	450,	447,	444,	
	442,	439,	437,	434,	432,	430,	427,	425,	423,	421,	
	419,	417,	415,	413,	411,	409,	407,	405,	404,	402,	
	400,	399,	397,	396,	394,	392,	391,	390,	388,	387,	
	385,	384,	383,	381,	380,	379,	378,	377,	375,	374,	
	373,	372,	371,	370,	369,	368,	367,	366,	365,	364,	
	363,	362,	361,	360,	359,	358,	358,	357,	356,	355,	
	354,	354,	353,	352,	351,	351,	350,	349,	348,	348,	
	347,	346,	346,	345,	345,	344,	343,	343,	342,	342,	
	341,	341,	340,	339,	339,	338,	338,	337,	337,	337,	
	336,	336,	335,	335,	334,	334,	333,	333,	333,	332,	
	332,	332,	331,	331,	330,	330,	330,	329,	329,	329,	
	329,	328,	328,	328,	327,	327,	327,	327,	326,	326,	
	326,	326,	325,	325,	325,	325,	325,	324,	324,	324,	
	324,	324,	324,	323,	323,	323,	323,	323,	323,	323,	
	323,	322,	322,	322,	322,	322,	322,	322,	322,	322,	
	322,	322,	322,	322,	322,	322,	322,	322,	322,	322,	
	322,	322,	322,	322,	322,	322,	322,	322,	322,	322,	
	322,	322,	322,	322,	322,	322,	322,	322,	322,	322,	
	322,	322,	322,	322,	322,	322,	322,	322,	322,	322,	
	322,	322,	322,	322,	322,	322,	322,	322,	322,	323,	
	323,	323,	323,	323,	323,	323,	323,	324,	324,	324,	
	324,	324,	324,	325,	325,	325,	325,	325,	326,	326,	
	326,	326,	327,	327,	327,	327,	328,	328,	328,	329,	
	329,	329,	329,	330,	330,	330,	331,	331,	332,	332,	
	332,	333,	333,	333,	334,	334,	335,	335,	336,	336,	
	337,	337,	337,	338,	338,	339,	339,	340,	341,	341,	
	342,	342,	343,	343,	344,	345,	345,	346,	346,	347,	
	348,	348,	349,	350,	351,	351,	352,	353,	354,	354,	
	355,	356,	357,	358,	358,	359,	360,	361,	362,	363,	
	364,	365,	366,	367,	368,	369,	370,	371,	372,	373,	
	374,	375,	377,	378,	379,	380,	381,	383,	384,	385,	
	387,	388,	390,	391,	392,	394,	396,	397,	399,	400,	
	402,	404,	405,	407,	409,	411,	413,	415,	417,	419,	
	421,	423,	425,	427,	430,	432,	434,	437,	439,	442,	
	444,	447,	450,	453,	456,	459,	462,	465,	468,	472,	
	475,	479,	483,	486,	490,	494,	499,	503,	508,	512,	
	517,	522,	527,	533,	538,	544,	550,	557,	563,	570,	
	578,	585,	593,	602,	611,	620,	630,	640,	651,	662,	
	674,	686,	698,	712,	726,	740,	756,	772,	789,	807,	
	826,	847,	868,	891,	916,	942,	970,	1001,	1034,	1069,	
	1108,	1151,	1198,	1249,	1307,	1372,	1445,	1529,	1625,	1738,	
	1873,	2036,	2238,	2497,	2844,	3334,	4087,	5393,	7894,	9999,	1
};


// S曲线高速旋转90度脉冲周期列表，最大加速度80r/s^2，加减速时间0.075S
const u16 Rot90_HS_List[250] = {
	9999,	4838,	2985,	2277,	1882,	1623,	1439,	1299,	1189,	1099,	
	1025,	962,	908,	860,	819,	782,	749,	719,	692,	668,	
	645,	625,	606,	589,	573,	559,	547,	535,	524,	514,	
	505,	496,	488,	480,	473,	466,	460,	454,	448,	443,	
	437,	433,	428,	424,	419,	415,	411,	408,	404,	401,	
	397,	394,	391,	388,	386,	383,	380,	378,	376,	373,	
	371,	369,	367,	365,	363,	361,	359,	358,	356,	354,	
	353,	351,	350,	349,	347,	346,	345,	343,	342,	341,	
	340,	339,	338,	337,	336,	335,	334,	334,	333,	332,	
	331,	331,	330,	329,	329,	328,	327,	327,	326,	326,	
	325,	325,	325,	324,	324,	324,	323,	323,	323,	323,	
	322,	322,	322,	322,	322,	322,	322,	322,	322,
	322,	322,	322,	322,	322,	322,	322,	322,	322,	322,	
	322,	322,	322,	322,	322,	322,	322,	322,	322,	322,	
	323,	323,	323,	323,	324,	324,	324,	325,	325,	325,	
	326,	326,	327,	327,	328,	329,	329,	330,	331,	331,	
	332,	333,	334,	334,	335,	336,	337,	338,	339,	340,	
	341,	342,	343,	345,	346,	347,	349,	350,	351,	353,	
	354,	356,	358,	359,	361,	363,	365,	367,	369,	371,	
	373,	376,	378,	380,	383,	386,	388,	391,	394,	397,	
	401,	404,	408,	411,	415,	419,	424,	428,	433,	437,	
	443,	448,	454,	460,	466,	473,	480,	488,	496,	505,	
	514,	524,	535,	547,	559,	573,	589,	606,	625,	645,	
	668,	692,	719,	749,	782,	819,	860,	908,	962,	1025,	
	1099,	1189,	1299,	1439,	1623,	1882,	2277,	2985,	4838,	9999,	1
};

// S曲线高速旋转180度脉冲周期列表，最大加速度80r/s^2，加减速时间0.1S
const u16 Rot180_HS_List[501] = {
	9999,	5555,	3405,	2579,	2121,	1824,	1613,	1453,	1328,	1227,	
	1143,	1071,	1010,	957,	911,	869,	832,	799,	769,	741,	
	716,	693,	672,	652,	633,	616,	600,	585,	571,	557,	
	545,	533,	522,	511,	501,	491,	482,	473,	465,	457,	
	450,	443,	436,	430,	424,	418,	413,	408,	403,	398,	
	394,	389,	385,	381,	378,	374,	370,	367,	364,	361,	
	358,	355,	352,	349,	346,	344,	341,	339,	336,	334,	
	332,	330,	328,	326,	324,	322,	320,	318,	316,	314,	
	313,	311,	309,	308,	306,	305,	303,	302,	301,	299,	
	298,	297,	295,	294,	293,	292,	291,	289,	288,	287,	
	286,	285,	284,	283,	282,	281,	280,	279,	278,	277,	
	277,	276,	275,	274,	273,	273,	272,	271,	270,	270,	
	269,	268,	267,	267,	266,	266,	265,	264,	264,	263,	
	263,	262,	261,	261,	260,	260,	259,	259,	258,	258,	
	257,	257,	256,	256,	256,	255,	255,	254,	254,	254,	
	253,	253,	252,	252,	252,	251,	251,	251,	250,	250,	
	250,	249,	249,	249,	249,	248,	248,	248,	248,	247,	
	247,	247,	247,	246,	246,	246,	246,	246,	246,	245,	
	245,	245,	245,	245,	245,	244,	244,	244,	244,	244,	
	244,	244,	244,	244,	243,	243,	243,	243,	243,	243,
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	243,	243,	243,	243,	
	243,	243,	243,	243,	243,	243,	244,	244,	244,	244,	
	244,	244,	244,	244,	244,	245,	245,	245,	245,	245,	
	245,	246,	246,	246,	246,	246,	246,	247,	247,	247,	
	247,	248,	248,	248,	248,	249,	249,	249,	249,	250,	
	250,	250,	251,	251,	251,	252,	252,	252,	253,	253,	
	254,	254,	254,	255,	255,	256,	256,	256,	257,	257,	
	258,	258,	259,	259,	260,	260,	261,	261,	262,	263,	
	263,	264,	264,	265,	266,	266,	267,	267,	268,	269,	
	270,	270,	271,	272,	273,	273,	274,	275,	276,	277,	
	277,	278,	279,	280,	281,	282,	283,	284,	285,	286,	
	287,	288,	289,	291,	292,	293,	294,	295,	297,	298,	
	299,	301,	302,	303,	305,	306,	308,	309,	311,	313,	
	314,	316,	318,	320,	322,	324,	326,	328,	330,	332,	
	334,	336,	339,	341,	344,	346,	349,	352,	355,	358,	
	361,	364,	367,	370,	374,	378,	381,	385,	389,	394,	
	398,	403,	408,	413,	418,	424,	430,	436,	443,	450,	
	457,	465,	473,	482,	491,	501,	511,	522,	533,	545,	
	557,	571,	585,	600,	616,	633,	652,	672,	693,	716,	
	741,	769,	799,	832,	869,	911,	957,	1010,	1071,	1143,	
	1227,	1328,	1453,	1613,	1824,	2121,	2579,	3405,	5555,	9999, 1
};



// 步进电机初始化函数
void Step_Init(void)
{
	RCC->APB2ENR|=1<<11;		//TIM1时钟使能
	RCC->APB2ENR|=1<<2;    	//使能PORTA时钟
	RCC->APB2ENR|=1<<3;    	//使能PORTB时钟
	
	GPIOA->CRL&=0x0F00FFFF;	//PA4\5\7输出
	GPIOA->CRL|=0x3F33FFFF;	//PA4\5\7推挽输出
	
	GPIOB->CRL&=0XFFFFFFF0;	//PB0输出
	GPIOB->CRL|=0X00000003;	//PB0推挽输出
	
	GPIOB->CRH&=0XF000FFFF;	//PB13/14输出，PB12输入
	GPIOB->CRH|=0X0BB40000;	//复用功能推挽输出，PB12浮空输入
	
	TIM1->ARR = 1;				//设定计数器自动重装值 
	TIM1->PSC = 71;  			//预分频器72,得到1000Khz的计数时钟		  
	TIM1->DIER|=1<<0;   	//允许更新中断	  
	TIM1->DIER|=1<<7;   	//允许刹车中断
	TIM1->SR&=~(1<<0);		//清除中断标志位
	TIM1->CR1=0x0080;   	//ARPE使能
	
	TIM1->CCMR1|=7<<4;  	//CH1 PWM2模式		 
	TIM1->CCMR1|=1<<3; 		//CH1 预装载使能
//	TIM1->CCER|=1<<3;   	//OC1NE 输出反相  
	TIM1->CCER|=1<<2;			//OC1NE 输出使能
	
	TIM1->CCMR1|=7<<12;		//CH2 PWM2模式		 
	TIM1->CCMR1|=1<<11;		//CH2 预装载使能
//	TIM1->CCER|=1<<7;   	//OC2NE 输出反相
	TIM1->CCER|=1<<6;			//OC2NE 输出使能
	
  MY_NVIC_Init(1,1,TIM1_UP_IRQn,2);		//抢占1，子优先级1，组2
	MY_NVIC_Init(1,1,TIM1_BRK_IRQn,2);	//抢占1，子优先级1，组2	
	
	TIM1->CCR1 = 0;	// 将通道1比较值设为0，即在引脚上持续输出高电平，电机接口输出低电平
	TIM1->CCR2 = 0;	// 将通道2比较值设为0，即在引脚上持续输出高电平，电机接口输出低电平
	
	TIM1->ARR = 1;
	
	TIM1->BDTR |= 1<<13;	// 刹车输入高电平有效
	__nop();
	TIM1->BDTR |= 1<<12;	//开启刹车使能
	__nop();
	TIM1->BDTR |= 1<<15;	// 主输出使能
	__nop();
	
	ENA1 = 1;						// 左右电机使能
	ENA2 = 1;
	
//	TIM1->CR1|=0x01;    	//使能定时器1
}


// 步进电机旋转90度函数
void Step_Rot_90(u8 dir, char motor)
{
	if(Get_SpeedMode() == 0)	// 低速模式
	{
		if(Get_CubeLock_State() == 1)	// 魔方闭锁
		{
			S_Curve_List = (u16*)Rot90_LS_List;			// 普通速度旋转90
			len = sizeof(Rot90_LS_List)/sizeof(u16);
		}
		else		// 魔方开锁
		{
			S_Curve_List = (u16*)Rot90_MS_List;		// 高速旋转90
			len = sizeof(Rot90_MS_List)/sizeof(u16);
		}
	}
	else if(Get_SpeedMode() == 1)	// 高速模式
	{
		if(Get_CubeLock_State() == 1)	// 魔方闭锁
		{
			S_Curve_List = (u16*)Rot90_MS_List;			// 普通速度旋转90
			len = sizeof(Rot90_MS_List)/sizeof(u16);
		}
		else		// 魔方开锁
		{
			S_Curve_List = (u16*)Rot90_HS_List;		// 高速旋转90
			len = sizeof(Rot90_HS_List)/sizeof(u16);
		}
	}
	
	motor_AB = motor;
	
	switch(motor)
	{
		case 'A':	DIR1=dir;	break;
		case 'B':	DIR2=dir;	break;
	}
	
	delay_ms(1);
	
	PulCnt = 0;					// 脉冲计数值置0
	TIM1->ARR = 1;
	TIM1->CNT = 0;
	
	TIM1->CR1|=0x01;    	//使能定时器1
	
	stepRun = 1;					// 电机运行状态置1
}


// 步进电机旋转180度函数
void Step_Rot_180(u8 dir, char motor)
{
	if(Get_SpeedMode() == 0)	// 低速模式
	{
		if(Get_CubeLock_State() == 1)	// 魔方闭锁
		{
			S_Curve_List = (u16*)Rot180_LS_List;		// 低速旋转180
			len = sizeof(Rot180_LS_List)/sizeof(u16);
		}
		else		// 魔方开锁
		{
			S_Curve_List = (u16*)Rot180_MS_List;		// 中速旋转180
			len = sizeof(Rot180_MS_List)/sizeof(u16);
		}
	}
	else if(Get_SpeedMode() == 1)	// 高速模式
	{
		if(Get_CubeLock_State() == 1)	// 魔方闭锁
		{
			S_Curve_List = (u16*)Rot180_MS_List;		// 中速旋转180
			len = sizeof(Rot180_MS_List)/sizeof(u16);
		}
		else		// 魔方开锁
		{
			S_Curve_List = (u16*)Rot180_HS_List;		// 高速旋转180
			len = sizeof(Rot180_HS_List)/sizeof(u16);
		}
	}
	
	motor_AB = motor;
	
	switch(motor)
	{
		case 'A':	DIR1=dir;	break;
		case 'B':	DIR2=dir;	break;
	}
	
	delay_ms(1);
	
	PulCnt = 0;					// 脉冲计数值置0
	TIM1->ARR = 1000;
	TIM1->CNT = 0;
	
	TIM1->CR1|=0x01;    	//使能定时器1
	
	stepRun = 1;					// 电机运行状态置1
}


// 获取步进电机的运行状态
u8 Get_Step_Status(void)
{
	return stepRun;		// 返回电机运行状态
}

// 获取步进电机的完成状态
u8 Get_Step_Finish(void)
{
	u8 temp = stepFinish;
	
	stepFinish = 0;
	
	return temp;		// 返回电机完成状态
}


// 刹车复位处理函数
void BRK_Reset_Proc(void)
{	
	if(brkFlag == 1)					// 刹车标志为1
	{
		if(BRK == 0)						// 紧急开关按钮复位
		{
			TIM1->CCER |= 1<<2;
			TIM1->CCER |= 1<<6;
			PulCnt = 0;						// 脉冲计数值置0
			brkFlag = 0;					// 刹车标志复位
			TIM1->DIER |= 1<<7;		// 允许刹车中断
			TIM1->BDTR |= 1<<15;	// 主输出使能
			ENA1 = 1;
			ENA2 = 1;
			
			Set_Servo_Speed(4);		// 设置舵机速度
		}
	}
}

//定时器1中断服务程序	 
void TIM1_UP_IRQHandler(void)
{
	if(TIM1->SR&0X0001)	//溢出中断
	{
		if(PulCnt < len)
		{
			TIM1->ARR = S_Curve_List[PulCnt];	// 设置重装值
			switch(motor_AB)
			{
				case 'A':	TIM1->CCR1 = TIM1->ARR >> 1;	break;	// 设置左电机输出，占空比为50%
				case 'B':	TIM1->CCR2 = TIM1->ARR >> 1;	break;	// 设置右电机输出，占空比为50%
			}
			
			PulCnt++;
		}
		else
		{
			TIM1->CCR1 = 0;	// 将通道1比较值设为0，即在引脚上持续输出高电平，电机接口输出低电平
			TIM1->CCR2 = 0;	// 将通道2比较值设为0，即在引脚上持续输出高电平，电机接口输出低电平
			PulCnt = 0;					// 脉冲计数值置0
			TIM1->CR1&=0xFE;		// 停止定时器1
			stepRun = 0;				// 电机运行状态置0
			stepFinish = 1;			// 电机完成状态置1
		}
		TIM1->SR&=~(1<<0);	//清除中断标志位	
	}
}

//定时器1刹车中断服务函数
void TIM1_BRK_IRQHandler(void)
{
	if(TIM1->SR&(0x0001<<7))	//刹车中断
	{
		ENA1 = 0;
		ENA2 = 0;
		brkFlag = 1;						// 刹车信号置1
		TIM1->CCER&=~(1<<2);
		TIM1->CCER&=~(1<<6);
		TIM1->DIER&=~(1<<7);   	// 禁止刹车中断
		TIM1->CR1&=0xFE;				// 停止定时器1
		TIM1->CNT = TIM1->ARR;
		stepRun = 0;				// 电机运行状态置0
		
		TIM1->SR&=~(1<<7);	//清除中断标志位
	}
}

